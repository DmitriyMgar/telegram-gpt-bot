# План реализации: Замена статической авторизации на проверку подписки на канал

## Анализ текущей архитектуры

### Текущая система авторизации:
- В `config.py` определен статический список `ALLOWED_USERS = [792501309, 916387745, 2120274462]`
- В `main.py` функция `is_authorized(user_id: int) -> bool` проверяет наличие `user_id` в этом списке
- Проверка происходит в каждом обработчике команд:
  - `start()` - приветствие
  - `reset()` - сброс истории
  - `handle_message()` - обработка текстовых сообщений
  - `history()` - показ истории
  - `export()` - экспорт истории

### Целевой канал:
- URL: https://t.me/logloss_notes
- Chat ID: @logloss_notes
- Бот уже является администратором канала

## План изменений

### 1. Создание модуля для проверки подписки

**Файл: `subscription_checker.py`**
- Создать асинхронную функцию `check_channel_subscription(bot_token: str, channel_id: str, user_id: int) -> bool`
- Использовать HTTP-запрос к Telegram Bot API: `GET https://api.telegram.org/bot<bot_token>/getChatMember?chat_id=@logloss_notes&user_id=<user_id>`
- Обработать возможные статусы подписки:
  - `creator` - создатель канала (разрешен)
  - `administrator` - администратор (разрешен)
  - `member` - участник (разрешен)
  - `restricted` - ограничен (запрещен)
  - `left` - покинул канал (запрещен)
  - `kicked` - исключен (запрещен)
- Добавить обработку ошибок (пользователь не найден, канал недоступен и т.д.)
- Добавить логирование всех проверок

### 2. Обновление конфигурации

**Файл: `config.py`**
- Добавить переменную окружения `CHANNEL_ID` в `.env`
- Удалить или закомментировать `ALLOWED_USERS`
- Добавить импорт канала из переменной окружения

### 3. Модификация функции авторизации

**Файл: `main.py`**
- Заменить `is_authorized()` на асинхронную `is_authorized_async()`
- Вместо проверки статического списка использовать `check_channel_subscription()`
- Обновить все обработчики команд для использования новой асинхронной функции
- Добавить информативные сообщения для неавторизованных пользователей

### 4. Кеширование результатов проверки

**Расширение: `subscription_checker.py`**
- Добавить Redis-кеш для результатов проверки подписки
- Время жизни кеша: 5-10 минут (баланс между актуальностью и нагрузкой на API)
- Ключ кеша: `subscription:{user_id}`
- Значение: `true`/`false`

### 5. Обработка граничных случаев

- Пользователь заблокировал бота
- Канал временно недоступен
- Лимиты API Telegram
- Таймауты HTTP-запросов
- Fallback-механизм при недоступности API

### 6. Обновление зависимостей

**Файл: `requirements.txt`**
- Добавить `aiohttp` для асинхронных HTTP-запросов
- Или использовать встроенные возможности `python-telegram-bot`

## Последовательность реализации

1. **Этап 1**: Создать `subscription_checker.py` с базовой функциональностью
2. **Этап 2**: Обновить `config.py` для работы с каналом
3. **Этап 3**: Модифицировать `main.py` для использования новой авторизации
4. **Этап 4**: Добавить кеширование в Redis
5. **Этап 5**: Тестирование с разными типами пользователей
6. **Этап 6**: Добавить обработку ошибок и логирование

## Возможные улучшения

- Добавить команду `/subscribe` с инструкцией как подписаться
- Уведомления о необходимости подписки с прямой ссылкой на канал
- Метрики количества проверок подписки


## Риски и митигация

### Риски:
1. **Лимиты API**: Telegram ограничивает количество запросов
2. **Задержки**: HTTP-запросы могут увеличить время отклика
3. **Доступность**: API может быть временно недоступен

### Митигация:
1. **Кеширование**: Снижение количества запросов к API
2. **Асинхронность**: Неблокирующие запросы
3. **Fallback**: Резервный механизм авторизации
4. **Таймауты**: Ограничение времени ожидания ответа 