#!/bin/bash

# Telegram GPT Bot - Logs Script
# –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤ —Å —Ä–∞–∑–ª–∏—á–Ω—ã–º–∏ –æ–ø—Ü–∏—è–º–∏

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
BOT_DIR="$SCRIPT_DIR"
LOG_FILE="$BOT_DIR/bot.log"

# –§—É–Ω–∫—Ü–∏—è –ø–æ–º–æ—â–∏
show_help() {
    echo "üìù –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤ Telegram GPT Bot"
    echo ""
    echo "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:"
    echo "  ./logs.sh [–æ–ø—Ü–∏—è]"
    echo ""
    echo "–û–ø—Ü–∏–∏:"
    echo "  -f, --follow     –°–ª–µ–¥–∏—Ç—å –∑–∞ –ª–æ–≥–∞–º–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)"
    echo "  -t, --tail N     –ü–æ–∫–∞–∑–∞—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ N —Å—Ç—Ä–æ–∫ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 50)"
    echo "  -e, --errors     –ü–æ–∫–∞–∑–∞—Ç—å —Ç–æ–ª—å–∫–æ –æ—à–∏–±–∫–∏"
    echo "  -w, --warnings   –ü–æ–∫–∞–∑–∞—Ç—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –∏ –æ—à–∏–±–∫–∏"
    echo "  -s, --search     –ü–æ–∏—Å–∫ –ø–æ –ª–æ–≥–∞–º"
    echo "  -c, --clear      –û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥–∏"
    echo "  -h, --help       –ü–æ–∫–∞–∑–∞—Ç—å —ç—Ç—É —Å–ø—Ä–∞–≤–∫—É"
    echo ""
    echo "–ü—Ä–∏–º–µ—Ä—ã:"
    echo "  ./logs.sh                # –°–ª–µ–¥–∏—Ç—å –∑–∞ –ª–æ–≥–∞–º–∏"
    echo "  ./logs.sh -t 100         # –ü–æ—Å–ª–µ–¥–Ω–∏–µ 100 —Å—Ç—Ä–æ–∫"
    echo "  ./logs.sh -e             # –¢–æ–ª—å–∫–æ –æ—à–∏–±–∫–∏"
    echo "  ./logs.sh -s \"user_id\"   # –ü–æ–∏—Å–∫ –ø–æ —Ç–µ–∫—Å—Ç—É"
}

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –ª–æ–≥ —Ñ–∞–π–ª–∞
check_log_file() {
    if [ ! -f "$LOG_FILE" ]; then
        echo "‚ùå –õ–æ–≥ —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω: $LOG_FILE"
        echo "üí° –í–æ–∑–º–æ–∂–Ω–æ, –±–æ—Ç –µ—â–µ –Ω–µ –∑–∞–ø—É—Å–∫–∞–ª—Å—è –∏–ª–∏ –ª–æ–≥ —Ñ–∞–π–ª –±—ã–ª —É–¥–∞–ª–µ–Ω"
        exit 1
    fi
}

# –§—É–Ω–∫—Ü–∏—è –æ—á–∏—Å—Ç–∫–∏ –ª–æ–≥–æ–≤
clear_logs() {
    echo "üóëÔ∏è  –û—á–∏—Å—Ç–∫–∞ –ª–æ–≥–æ–≤..."
    read -p "‚ùì –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥ —Ñ–∞–π–ª? (y/N): " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        # –°–æ–∑–¥–∞–µ–º –±—ç–∫–∞–ø –ø–µ—Ä–µ–¥ –æ—á–∏—Å—Ç–∫–æ–π
        BACKUP_FILE="$BOT_DIR/bot.log.backup.$(date +%Y%m%d_%H%M%S)"
        cp "$LOG_FILE" "$BACKUP_FILE"
        echo "üíæ –°–æ–∑–¥–∞–Ω –±—ç–∫–∞–ø: $BACKUP_FILE"
        
        # –û—á–∏—Å—Ç–∫–∞ —Ñ–∞–π–ª–∞
        > "$LOG_FILE"
        echo "‚úÖ –õ–æ–≥–∏ –æ—á–∏—â–µ–Ω—ã"
    else
        echo "‚ùå –û—Ç–º–µ–Ω–µ–Ω–æ"
    fi
}

# –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞
case "${1:-}" in
    -h|--help)
        show_help
        exit 0
        ;;
    -c|--clear)
        check_log_file
        clear_logs
        exit 0
        ;;
    -e|--errors)
        check_log_file
        echo "‚ùå –ü–æ–∫–∞–∑ —Ç–æ–ª—å–∫–æ –æ—à–∏–±–æ–∫ –∏–∑ $LOG_FILE"
        echo "=================================="
        grep -i "ERROR\|CRITICAL" "$LOG_FILE" || echo "‚úÖ –û—à–∏–±–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ"
        ;;
    -w|--warnings)
        check_log_file
        echo "‚ö†Ô∏è  –ü–æ–∫–∞–∑ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π –∏ –æ—à–∏–±–æ–∫ –∏–∑ $LOG_FILE"
        echo "=================================="
        grep -i "WARNING\|ERROR\|CRITICAL" "$LOG_FILE" || echo "‚úÖ –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π –∏ –æ—à–∏–±–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ"
        ;;
    -s|--search)
        check_log_file
        if [ -z "$2" ]; then
            read -p "üîç –í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –¥–ª—è –ø–æ–∏—Å–∫–∞: " SEARCH_TEXT
        else
            SEARCH_TEXT="$2"
        fi
        echo "üîç –ü–æ–∏—Å–∫ '$SEARCH_TEXT' –≤ $LOG_FILE"
        echo "=================================="
        grep -i --color=always "$SEARCH_TEXT" "$LOG_FILE" || echo "‚ùå –ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ"
        ;;
    -t|--tail)
        check_log_file
        LINES="${2:-50}"
        echo "üìÑ –ü–æ—Å–ª–µ–¥–Ω–∏–µ $LINES —Å—Ç—Ä–æ–∫ –∏–∑ $LOG_FILE"
        echo "=================================="
        tail -n "$LINES" "$LOG_FILE"
        ;;
    -f|--follow|"")
        check_log_file
        echo "üìù –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏"
        echo "üí° –ù–∞–∂–º–∏—Ç–µ Ctrl+C –¥–ª—è –≤—ã—Ö–æ–¥–∞"
        echo "=================================="
        tail -f "$LOG_FILE"
        ;;
    *)
        echo "‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ–ø—Ü–∏—è: $1"
        echo "üí° –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ ./logs.sh --help –¥–ª—è —Å–ø—Ä–∞–≤–∫–∏"
        exit 1
        ;;
esac 